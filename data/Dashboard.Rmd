---
title: "Integración en la UE" 
author: "Alba Nuez Vilà"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
#Librerías de interés
library(flexdashboard)
library(tidyverse)
library(maps)
library(plotly)
library(shiny)
library(readxl)
library(dplyr)
library(leaflet)
library(lattice)
library(ggplot2)
library(gridExtra)
library(sf)  
library(leaflet)  
library(rnaturalearth)
library(rnaturalearthdata)
```

```{r}
#Cargamos la base de datos depurada
df <- read_excel("Depurada_ESS11_subset.xlsx")
#La variable país debe ser un factor
df$cntry <- as.factor(df$cntry)
#Nombre de los países
country_names <- c(
  AL = "Albania", AT = "Austria", BE = "Belgium", BG = "Bulgaria", 
  CH = "Switzerland", CY = "Cyprus", CZ = "Czechia", DE = "Germany", 
  DK = "Denmark", EE = "Estonia", ES = "Spain", FI = "Finland", 
  FR = "France", GB = "United Kingdom", GE = "Georgia", GR = "Greece", 
  HR = "Croatia", HU = "Hungary", IE = "Ireland", IS = "Iceland", 
  IL = "Israel", IT = "Italy", LT = "Lithuania", LU = "Luxembourg", 
  LV = "Latvia", ME = "Montenegro", MK = "North Macedonia", NL = "Netherlands", 
  NO = "Norway", PL = "Poland", PT = "Portugal", RO = "Romania", 
  RS = "Serbia", RU = "Russian Federation", SE = "Sweden", SI = "Slovenia", 
  SK = "Slovakia", TR = "Turkey", UA = "Ukraine", XK = "Kosovo"
)
df$cntry <- factor(df$cntry, levels = names(country_names), labels = country_names)

# Filtrar países con conteos mayores que 0
country_counts <- df %>% group_by(cntry) %>% summarise(count = n())
valid_countries <- country_counts %>% filter(count > 0) %>% pull(cntry)

# Filtrar el dataframe para incluir solo países válidos
df <- df %>% filter(cntry %in% valid_countries)
df$cntry <- droplevels(df$cntry)
```

Página 1: Actitud e Inmigración
=======================================================================
Column {.sidebar}
-----------------------------------------------------------------------

### Selección de país

```{r}
selectInput('cntry', 'Selecciona el país que quieras visualizar:', 
            choices = c("Mostrar todos los países" = "all", levels(df$cntry)), 
            selected = "all")
```

### Sobre el estudio

<div style="font-size: 0.8em;">
  <p style="text-align: justify;">Este dashboard muestra cómo cambian las opiniones en los distintos países europeos respecto a la actitud hacia los demás, al impacto de la inmigración, y a la adopción de niños y niñas por parte de personas homosexuales.</p>
  <p style="text-align: center;"><b>Página 1: ¿Cómo varía la actitud hacia los demás en diferentes países de la UE? ¿Cómo se correlaciona con la percepción del bienestar en relación con la inmigración?</b></p>
</div>



Column {data-height=80}
-----------------------------------------------------------------------

### ¿Qué actitud se adopta hacia los demás?

```{r}
renderPlot({
  selected_country <- input$cntry
  
  # Check if "Show all countries" is selected
  if (selected_country == "all") {
    filtered_df <- df
  } else {
    filtered_df <- df %>% filter(cntry == selected_country)
  }
  
  ggplot(filtered_df, aes(x = factor(actitud_positiva))) +
    geom_bar(fill = "coral1", color = "white") +
    labs(title = "Distribución de 'Actitud hacia los demás'", x = "Actitud", y = "Frecuencia") +
    geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5, size = 3) +
    theme(
      plot.title = element_text(hjust = 0.5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(color = "grey"),
      axis.text.x = element_text(angle = 90, hjust = 1, color = "black"),  # Rotate x-axis labels 90 degrees
      axis.text.y = element_text(color = "black"),
      axis.title = element_text(color = "black")
    )
})
```

### ¿Cómo impacta la inmigración en la calidad de vida?

```{r}
renderPlot({
  selected_country <- input$cntry
  
  # Check if "Show all countries" is selected
  if (selected_country == "all") {
    filtered_df <- df
  } else {
    filtered_df <- df %>% filter(cntry == selected_country)
  }
  
  possible_values_imwbcnt <- seq(min(filtered_df$imwbcnt, na.rm = TRUE), max(filtered_df$imwbcnt, na.rm = TRUE), by = 1)
  
  ggplot(filtered_df, aes(x = imwbcnt)) +
    geom_histogram(binwidth = 1, fill = "coral1", color = "white") +
    labs(title = "Distribución de 'Opinión calidad de vida e inmigración'", x = "Impacto en calidad de vida", y = "Frecuencia") +
    geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5, size = 3) +
    scale_x_continuous(breaks = possible_values_imwbcnt) +
    theme(
      plot.title = element_text(hjust = 0.5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(color = "grey"),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black")
    )
})
```

Column {data-height=100}
-----------------------------------------------------------------------
### ¿La actitud que tenemos hacia los demás correlaciona con nuestras opiniones acerca de la inmigración?

```{r}
renderPlot({
  selected_country <- input$cntry
  
  # Check if "Show all countries" is selected
  if (selected_country == "all") {
    filtered_df <- df
  } else {
    filtered_df <- df %>% filter(cntry == selected_country)
  }
  
  heatmap_data <- filtered_df %>%
    group_by(actitud_positiva, imwbcnt) %>%
    summarise(count = n()) %>%
    ungroup()
  
  heatmap_matrix <- xtabs(count ~ actitud_positiva + imwbcnt, data = heatmap_data)
  
  levelplot(heatmap_matrix, 
            xlab = "Actitud", 
            ylab = "Opinión inmigración y calidad de vida", 
            col.regions = colorRampPalette(c("white", "coral1")),
            scales = list(x = list(rot = 90)),
            panel = function(...) {
              panel.levelplot(...)
              panel.text(row(heatmap_matrix), col(heatmap_matrix), 
                         labels = heatmap_matrix, cex = 0.8)  # Display absolute counts
            },
            main = "Mapa de calor: Actitud vs opinión inmigración y calidad de vida")
})
```


Página 2: Adopción LGTBQ+
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

### Selección de país

```{r}
checkboxGroupInput("selected_cntry", "Selecciona los países que quieras visualizar:",
                   choices = unique(df$cntry),
                   selected = unique(df$cntry))
```

### Sobre el estudio

<div style="font-size: 0.8em;">
  <p style="text-align: justify;">Este dashboard muestra cómo cambian las opiniones en los distintos países europeos respecto a la actitud hacia los demás, al impacto de la inmigración, y a la adopción de niños y niñas por parte de personas homosexuales.</p>
  <p style="text-align: center;"><b>Página 2: ¿Cómo difieren las opiniones sobre la adopción LGTBQ+ entre países?</b></p>
</div>

Column {data-height=100}
-----------------------------------------------------------------------

### Opiniones sobre la adopción LGTBQ+

```{r}
renderPlot({
  # Prepare data reactively based on selected countries
  filtered_data <- df %>%
    filter(cntry %in% input$selected_cntry) %>%
    group_by(hmsacld, cntry) %>%
    summarise(count = n(), .groups = 'drop') %>%
    mutate(hmsacld = factor(hmsacld, levels = 1:5))
  
  # Create bar plot
  ggplot(filtered_data, aes(x = cntry, y = count, fill = hmsacld)) +
    geom_bar(stat = "identity") +
    labs(
      title = "Gráfico de Barras Apiladas: Adopción LGTBQ+ por País",
      x = "País",
      y = "Frecuencia",
      fill = "Adopción LGTBQ+"
    ) +
    scale_fill_manual(values = c("#67000D", "#A50F15", "#CB181D", "#EF3B2C", "#FB6A4A")) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
      plot.title = element_text(hjust = 0.5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(color = "grey"),
      axis.text.y = element_text(color = "black"),
      axis.title = element_text(color = "black")
    )
})
```

Página 2: Inmigración, economía e ingresos
=======================================================================
Column {.sidebar}
-----------------------------------------------------------------------

### Selección de país

```{r}
selectInput('cntry_page3', 'Selecciona el país que quieras visualizar:', 
            choices = c("Mostrar todos los países" = "all", levels(df$cntry)), 
            selected = "all")
```

### Sobre el estudio

<div style="font-size: 0.8em;">
  <p style="text-align: justify;">Este dashboard muestra cómo cambian las opiniones en los distintos países europeos respecto a la actitud hacia los demás, al impacto de la inmigración, y a la adopción de niños y niñas por parte de personas homosexuales.</p>
  <p style="text-align: center;"><b>Página 2: 2. ¿Existen patrones regionales en las opiniones sobre el impacto de la inmigración en la economía entre los países de la UE? ¿Cómo correlaciona con los ingresos?</b></p>
</div>


Column {data-height=80}
-----------------------------------------------------------------------

### Ingresos de los encuestados

```{r}
renderPlot({
  filteredData <- if(input$cntry_page3 == "all") {
    df
  } else {
    df %>% filter(cntry == input$cntry_page3)
  }

  filteredData$hinctnta <- as.numeric(filteredData$hinctnta)

  possible_values_hinctnta <- seq(min(filteredData$hinctnta, na.rm = TRUE), max(filteredData$hinctnta, na.rm = TRUE), by = 1)

  ggplot(filteredData, aes(x = hinctnta)) +
    geom_histogram(binwidth = 1.0, fill = "coral1", color = "white") +
    labs(title = "Distribución de 'ingresos'", x = "Deciles", y = "Frecuencia") +
    geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5, size = 3) +
    scale_x_continuous(breaks = possible_values_hinctnta) +
    theme(
      plot.title = element_text(hjust = 0.5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(color = "grey"),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black")
    )
})
```

### ¿Cómo impacta la inmigración en la economía?

```{r}
renderPlot({
  filteredData <- if(input$cntry_page3 == "all") {
    df
  } else {
    df %>% filter(cntry == input$cntry_page3)
  }

  possible_values_imbgeco <- seq(min(filteredData$imbgeco, na.rm = TRUE), max(filteredData$imbgeco, na.rm = TRUE), by = 1)

  ggplot(filteredData, aes(x = imbgeco)) +
    geom_histogram(binwidth = 1, fill = "coral1", color = "white") +
    labs(title = "Distribución de 'opinión economía e inmigración'", x = "Impacto en la economía", y = "Frecuencia") +
    geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5, size = 3) +
    scale_x_continuous(breaks = possible_values_imbgeco) +
    theme(
      plot.title = element_text(hjust = 0.5),
      panel.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(color = "grey"),
      axis.text = element_text(color = "black"),
      axis.title = element_text(color = "black")
    )
})
```

Column {data-height=100}
-----------------------------------------------------------------------
### ¿La actitud que tenemos hacia los demás correlaciona con nuestras opiniones acerca de la inmigración?

```{r}
# Load map data for Europe
europe_map <- ne_countries(continent = "Europe", returnclass = "sf")

# Ensure country names match those in your dataset
# Create a mapping data frame
country_mapping <- data.frame(
  iso_a3 = names(country_names),
  country = country_names,
  stringsAsFactors = FALSE
)

# Join the mapping data frame with europe_map
europe_map <- europe_map %>%
  left_join(country_mapping, by = "iso_a3")

# Example data: Replace with your actual data
opinions_data <- df %>%
  group_by(cntry) %>%
  summarise(mean_impact = mean(imbgeco, na.rm = TRUE))

# Merge with map data
map_data <- europe_map %>%
  left_join(opinions_data, by = c("country" = "cntry"))

# Handle missing data
map_data <- map_data %>%
  filter(!is.na(mean_impact))

# Create leaflet map
renderLeaflet({
  if (nrow(map_data) == 0) {
    leaflet() %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addPopups(lng = 0, lat = 0, popup = "No data available", options = popupOptions(closeButton = FALSE))
  } else {
    leaflet(data = map_data) %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addPolygons(
        fillColor = ~colorNumeric(palette = "YlOrRd", domain = map_data$mean_impact)(mean_impact),
        weight = 1,
        opacity = 1,
        color = 'white',
        dashArray = '3',
        fillOpacity = 0.7,
        popup = ~paste("<strong>Country:</strong>", country, "<br>",
                       "<strong>Average Impact:</strong>", round(mean_impact, 2))
      ) %>%
      addLegend(pal = colorNumeric(palette = "YlOrRd", domain = map_data$mean_impact),
                values = ~mean_impact,
                title = "Impact on Economy",
                position = "bottomright")
  }
})
```

